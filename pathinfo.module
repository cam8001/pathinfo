<?php
/**
 * @file
 * Hooks and core functions for the pathinfo module.
 */

/**
 * Implements hook_init().
 */
function pathinfo_init() {
  if (user_access('view pathinfo') && !devel_silent() && variable_get('pathinfo_footer_display', TRUE)) {
    drupal_add_css(drupal_get_path('module', 'pathinfo') . '/pathinfo.css');
    register_shutdown_function('pathinfo_shutdown');
  }
}

/**
 * Implements hook_menu().
 */
function pathinfo_menu() {
  $items['admin/settings/pathinfo'] = array(
    'title' => 'Configure PathInfo settings',
    'position' => 'right',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('pathinfo_config_form'),
    'access arguments' => array('administer pathinfo'),
    'file' => 'pathinfo.admin.inc',
    'weight' => 3,
  );

  return $items;
}

/**
 * Implements hook_perm().
 */
function pathinfo_perm() {
  return array('administer pathinfo', 'view pathinfo');
}

/**
 * Implements hook_theme().
 */
function pathinfo_theme($existing, $type, $theme, $path) {
  return array(
    'pathinfo_served_by' => array(
      'arguments' => array('variables' => NULL),
      'file' => 'pathinfo.theme.inc',
    ),
    'pathinfo_core_api_link' => array(
      'arguments' => array('variables' => NULL),
      'file' => 'pathinfo.theme.inc',
    ),
  );
}

/**
 * Shutdown callback.
 */
function pathinfo_shutdown() {
  // Try not to break non html pages.
  if (pathinfo_html_page()) {
    print pathinfo_served_by(pathinfo_get_info());
  }
}

/**
 * Callback to show
 *
 * @param array $pathinfo
 *   Path information, in format defined by pathinfo_get_info().
 *
 * @return string
 *   HTML string describing path.
 *
 * @see pathinfo_get_info()
 * @see theme_pathinfo_served_by()
 */
function pathinfo_served_by($pathinfo) {
  // Module load include seems to be causing an error :(
  require_once 'pathinfo.theme.inc';
  return notheme_pathinfo_served_by($pathinfo);
}

/**
 * Get info about a supplied path, or the current path if none supplied.
 *
 * @return array
 *   An associative array containing the path info:
 *   - path: System path to url.
 *   - function: The function that serves the path.
 *   - arguments: Any arguments passed to the function that serves the path.
 *   - module: The module that contains the function.
 *   - filepath: Relative ath to the file that implements the function.
 *   - filepath_full: The full path to the file that contains the function.
 *   - line: The line the function is implemented on.
 *   - is_form: Whether or not the function is a form constructor.
 *   - is_core: Whether or not this module is in Drupal core.
 */
function pathinfo_get_info($path = NULL) {
  if ($path == NULL) {
    $path = pathinfo_get_current_path();
  }
  $menu = menu_get_item($path);
  $arguments = array_map('check_plain', $menu['page_arguments']);
  $arguments = $arguments;
  $function = $menu['page_callback'];
  $is_form = FALSE;
  // Get the module this callback is implemented in.
  if ($function == 'drupal_get_form') {
    // Form definitions are always served by drupal_get_form, so the first
    // argument that defines the form is much more useful.
    $function = $arguments[0];
    $is_form = TRUE;
    unset($arguments[0]);
  }
  $module = pathinfo_get_module_for_function($function);

  // Find the file this function is in.
  $reflection = new ReflectionFunction($function);
  $filepath_full = $reflection->getFileName();
  $line = $reflection->getStartLine();

  $is_core = pathinfo_module_is_core($module);
  $filepath = pathinfo_get_relative_path($filepath_full);

  return array(
    'path' => $path,
    'function' => $function,
    'arguments' => $arguments,
    'module' => $module,
    'filepath' => $filepath,
    'filepath_full' => $filepath_full,
    'line' => $line,
    'is_form' => $is_form,
    'is_core' => $is_core,
  );

}

/**
 * Returns the system url of the current page.
 *
 * @return string
 *   The path string (eg node/306).
 *
 * @see current_path()
 */
function pathinfo_get_current_path() {
  $path = $_GET['q'];
  // If there is no path, we must be looking at the front page.
  if (drupal_is_front_page()) {
    $path = drupal_get_normal_path(variable_get('site_frontpage', 'node'));
  }
  return $path;
}

/**
 * Given a function name, return the module that it appears in. This will
 * only work for functions that have the module name in them.
 *
 * @param string $function_name
 *   Name of the function you'd like to cehck.
 *
 * @return string
 *   The module name, or an empty string if not found.
 *
 * @todo test with modules with overlapping names, eg node and node_dog. Just
 * have to find some good test cases.
 *
 * @todo It seems that module_list() is very fast (use static cache), and we can
 * call it many times per request without a meaningful perfomance impact.
 * However, it is worth monitoring for performance issues.
 */
function pathinfo_get_module_for_function($function_name) {
  $implemented_in = '';
  $modules = module_list();
  // Go through all loaded modules.
  foreach ($modules as $module) {
    if (strstr($function_name, $module)) {
      if (strlen($module) > strlen($implemented_in)) {
        $implemented_in = $module;
      }
    }
  }

  return $implemented_in;
}

/**
 * Detects whether a page request delivers HTML or not.
 *
 * @return bool
 *   TRUE for HTML page requests, FALSE otherwise.
 *
 * @see devel_shutdown_real()
 */
function pathinfo_html_page() {
  if (function_exists('drupal_get_headers')) {
    $headers = drupal_get_headers();
    $formats = array('xml', 'javascript', 'json', 'plain', 'image', 'application', 'csv', 'x-comma-separated-values');
    foreach ($formats as $format) {
      if (strstr($headers, $format)) {
        return FALSE;
      }
    }
  }

  return TRUE;
}

/**
 * Detects whether a module is Drupal core or otherwise.
 *
 * @param string $module_name
 *   Machine name of a drupal module.
 *
 * @return bool
 *   TRUE if a core module, FALSE if not.
 */
function pathinfo_module_is_core($module_name) {
  $path = drupal_get_path('module', $module_name);
  if (substr($path, 0, 7) == 'modules') {
    return TRUE;
  }
  return FALSE;
}

/**
 * Strips local filesystem information from a files include path.
 *
 * @param string $fullpath
 *   Full path including the local Drupal installation directory.
 *
 * @return string
 *   Path relative to the Drupal installation directory.
 */
function pathinfo_get_relative_path($fullpath) {
  return str_replace(getcwd() . '/', '', $fullpath);
}
